---
title: "POMA: Statistical analysis tool for omics data"
subtitle: "Exploratory Data Analysis Report"
date: '`r format(Sys.Date(), "%B, %Y")`'
output:
  prettydoc::html_pretty:
    toc: true
    theme: cayman
    highlight: github
params:
  n: NA
  t: NA
---

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
# This file is part of POMA.

# POMA is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# POMA is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with POMA. If not, see <https://www.gnu.org/licenses/>.

data <- params$n
target <- params$t

# data <- read.table("/Users/pol/Dropbox/JosepVillanueva/231eribulin-counts.txt", header = T, sep = "\t")
# target <- read.table("/Users/pol/Dropbox/JosepVillanueva/231eribulin-samples.txt", header = T, sep = "\t")
```
 
```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
colnames(target) <- c("Sample", "Group", "Batch")

prot_names <- data$Accession
remove <- ncol(data) - nrow(target)
data <- data[, -c(1:remove)]
counts <- apply(data, 2, function(x) as.numeric(as.character(x)))
data <- data.frame(t(data))
colnames(data) <- prot_names
```

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
zeros <- data[, -which(colSums(data) != 0)]
data <- data[, which(colSums(data) != 0)]
```

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
nas <- sapply(data, function(x) sum(is.na(x)))
nas <- data.frame(number = nas[nas != 0])
nas$names <- rownames(nas)
```

# Summary

  + Your data has **`r nrow(target)`** subjects, **`r ncol(data)`** proteines and **`r length(table(target$Group))`** groups, that are **`r noquote(paste(shQuote(levels(as.factor(target$Group))), collapse=", "))`**.    

  + A **`r round(sum(is.na(data))/(nrow(data)*(ncol(data)))*100, 3)`%** of the values in your data are NAs (missing values). `r ifelse(nrow(nas) >= 1, paste0("The variables that have NA values are **",noquote(paste(shQuote(paste0(rownames(nas)," (",nas$number,")")), collapse=", ")),"**."), "")`
  
```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
if (nrow(nas) >= 1){
  nas%>%
    plot_ly(x=~names, y= ~number, color= ~names, legendgroup=~names, type = "bar", opacity = 0.7) %>%
    layout(title = "Missing values by Metabolite", yaxis = list(title = "Missing Values"), xaxis = list(title = ""))
}
```

  + Removed from the exploratory analysis **`r ncol(zeros)`** variables that only have zeros. `r ifelse(ncol(zeros) >= 1, paste0("This variables are **",noquote(paste(shQuote(colnames(zeros)), collapse=", ")),"**."), "")`

## Subject count by Groups

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
library(ggplot2)
library(reshape)

counts <- data.frame(table(target$Group))
colnames(counts) <- c("Group", "Counts")

ggplot(counts, aes(Group, Counts, fill = Group)) +
  geom_bar(stat="identity") +
  theme_minimal()
```

## Normality and Homogeneity

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
normality <- data.frame(pval = apply(data,2, function(x) {shapiro.test(x)$p.value}))
normality$pval <- p.adjust(normality$pval, method = "fdr")
percent.norm <- round((length(normality[normality$pval > 0.05,])/nrow(normality))*100,3)

normality$names <- rownames(normality)
names.normality <- normality[normality$pval > 0.05,2]

##

homo <- data.frame(pval=apply(dataX,2,function(x) {bartlett.test(x, dataX$Group)$p.value}))
homo$pval <- p.adjust(homo$pval, method = "fdr")
percent.homo <- round((length(homo[homo$pval > 0.05,])/nrow(homo))*100,3)

homo$names <- rownames(homo)
names.homo <- homo[homo$pval > 0.05,2]
```

  + **`r nrow(normality[normality$pval > 0.05,])`** out of your **`r nrow(normality)`** variables (**`r percent.norm`%**) have a normal distribution before log transformation. 
  
  + **`r nrow(homo[homo$pval > 0.05,])`** out of your **`r nrow(homo)`** variables (**`r percent.homo`%**) have homosedasticity before log transformation. 
  
# Variable Distribution

# Boxplots



  
# Density plots





